# diy-pcp-infra

Training Cloud infrastructure, based entirely on Open Source technologies.  
Based on awesome [Xavki's 'Infra de A Ã  Z'](https://www.youtube.com/playlist?list=PLn6POgpklwWpehxly1wOT6eB2NvZX9A-X) playlist. ([code](https://gitlab.com/xavki/infrastructure-cloud-infomaniak/-/tree/main)]

## Dependencies

- [terraform](https://github.com/hashicorp/terraform) for provisioning and managing cloud resources
- [ansible](https://github.com/ansible/ansible) for instance configurations
- [openstack cli](https://github.com/openstack/python-openstackclient) CLI client to interact with OpenStack
- ansible collections: install using `make ansible-install`
- Python > 3.11 required for Ansible and OpenStack CLI
- [molecule](https://github.com/ansible/molecule) for testing ansible roles
- [molecule pluggin docker](https://github.com/ansible-community/molecule-plugins) docker driver for molecule
- [testinfra](https://github.com/pytest-dev/pytest-testinfra) for testing using molecule with python

### (optional) Dependencies

This section covers dependencies related to developer experience that are not required to deploy the infrastructure.

- GNU make: used to manage project tasks (with .PHONY)
- [ansible-lint](https://github.com/ansible/ansible-lint) Ansible linter
- [tflint](https://github.com/terraform-linters/tflint) Terraform linter
- [pre-commit](https://github.com/pre-commit/pre-commit) pre-commit hooks, used to trigger Checkov and Gitleaks
- [checkov](https://github.com/bridgecrewio/checkov) static code analysis tool for infrastructure-as-code, Terraform here
- [gitleaks](https://github.com/gitleaks/gitleaks) tool for detecting secrets before committing

## Infrastructure Overview

Infrastructure can be accessed from the internet from the OpenVPN instance with an OpenVPN-compatible client or from Traefik using an exposed web service.

### VM only version

![docs/diy-pcp-infra.excalidraw.png](docs/diy-pcp-infra.excalidraw.png)

### VM/K8S version

![docs/diy-pcp-infra-k8s.excalidraw.png](docs/diy-pcp-infra-k8s.excalidraw.png)

## Provisioning with Terraform

Infrastructure provisioning is done using Terraform with the OpenStack provider. It can be deployed on an OpenStack-compatible infrastructure.
First prepare your terraform backend and initialize backend for the different infrastructure units and modules using `make tf-init`, backend sample config is available [./terraform/backend.conf.sample](./terraform/backend.conf.sample).

Three different infrastructure units can be deployed:

### VPN

[./terraform/vpn](./terraform/vpn) is the first infrastructure unit. It contains the VPN instance and the public IP to connect to the VPN.

Once deployed, you can connect to the instance using an OpenVPN client and the public floating IP with the certificate generated by [./ansible/roles/openvpn_client](./ansible/roles/openvpn_client).

You can use the `terraform` CLI in the [./terraform/vpn](./terraform/vpn) folder. Ensure you have `tfvars` and Ansible environment set up before executing. Associated Ansible is run by Terraform `null_resource` that executes shell scripts.

### Infra

[./terraform/infra](./terraform/infra) is used to deploy all other resources. **Requires VPN and backup to be provisioned**.

You can use the `terraform` CLI in the `./terraform/infra` folder. Ensure you have `tfvars` set up before executing. After infrastructure provisioning, configuration can be applied using [./ansible playbooks](./ansible).

### Backup

[./terraform/backup](./terraform/backup) contains an S3 buckets, mainly used for backups with Restic by the [./ansible/roles/backup](./ansible/roles/backup) Ansible role.

## Configuration with Ansible

Configuration of the instances provisioned by Terraform is done using Ansible playbooks. Find below a simple description of all the playbooks.

The simplest way to retrieve Ansible hosts for the infrastructure deployment is to use the [OpenStack Ansible dynamic inventory](https://docs.ansible.com/ansible/latest/collections/openstack/cloud/openstack_inventory.html) (`make ansible-inventory`).

Extra variables (`-e`) are configured using files in the git-ignored `ansible/envs` folder. Sample files are available in [./ansible/envs_sample](./ansible/envs_sample) you can copy them to create your own before running Ansible playbooks.

| Playbook                                                             | Description                                                                         |
| -------------------------------------------------------------------- | ----------------------------------------------------------------------------------- |
| [./ansible/pb_all.yml](./ansible/pb_all.yml)                         | Base configurations on all instances (basic tools, DNS, etc.).                      |
| [./ansible/pb_all_hardening.yml](./ansible/pb_all_hardening.yml)     | Apply battle-tested hardening on all instances.                                     |
| [./ansible/pb_consul.yml](./ansible/pb_consul.yml)                   | Configure the Consul cluster instances and install Consul agent on other instances. |
| [./ansible/pb_consul_services.yml](./ansible/pb_consul_services.yml) | Configure Consul common services on all instances (OS metrics exporter).            |
| [./ansible/pb_monitoring.yml](./ansible/pb_monitoring.yml)           | Configure monitoring tools such as Grafana, VictoriaMetrics, AlertManager, etc.     |
| [./ansible/pb_logging.yml](./ansible/pb_logging.yml)                 | Configure Loki for log aggregation.                                                 |
| [./ansible/pb_traefik.yml](./ansible/pb_traefik.yml)                 | Configure the Traefik instance.                                                     |
| [./ansible/pb_openvpn.yml](./ansible/pb_openvpn.yml)                 | Configure the OpenVPN server.                                                       |
| [./ansible/pb_openvpn_client.yml](./ansible/pb_openvpn_client.yml)   | Configure OpenVPN client certificates.                                              |
| [./ansible/pb_postgresql_ha.yml](./ansible/pb_postgresql_ha.yml)     | Configure Postgresql cluster                                                        |
| [./ansible/pb_mattermost.yml](./ansible/pb_mattermost.yml)           | Configure Mattermost instance                                                       |
| [./ansible/pb_tracing.yml](./ansible/pb_tracing.yml)                 | Configure Tempo backend instance                                                    |
| [./ansible/pb_keycloak.yml](./ansible/pb_keycloak.yml)               | Configure Keycloak instance                                                         |
| [./ansible/pb_gitlab.yml](./ansible/pb_gitlab.yml)                   | Configure Gitlab instance                                                           |
| [./ansible/pb_kubernetes.yml](./ansible/pb_kubernetes.yml)           | Configure Kubernetes cluster instances                                              |
| [./ansible/pb_kubernetes_apps.yml](./ansible/pb_kubernetes_apps.yml) | Deploy monitoring stacks on Kubernetes cluster                                      |
